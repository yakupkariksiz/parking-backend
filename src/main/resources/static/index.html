<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parking Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 640px; /* 480 yerine 640 */
            margin: 40px auto;
            background: #ffffff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 14px;          /* 10 â†’ 12 */
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1.05rem;          /* biraz daha bÃ¼yÃ¼k */
            box-sizing: border-box;
            margin-bottom: 16px;
        }


        h1 {
            font-size: 1.6rem;
            margin-top: 0;
            margin-bottom: 16px;
            text-align: center;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            box-sizing: border-box;
            margin-bottom: 16px;
        }

        button {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: #2563eb;
            color: white;
        }

        button:disabled {
            opacity: 0.6;
            cursor: default;
        }

        .message {
            margin-top: 16px;
            text-align: center;
            font-size: 0.95rem;
        }

        .message.success {
            color: #15803d;
        }

        .message.error {
            color: #b91c1c;
        }

        .nav {
            text-align: center;
            margin-top: 12px;
            font-size: 0.9rem;
        }

        .nav a {
            color: #2563eb;
            text-decoration: none;
        }

        .nav a:hover {
            text-decoration: underline;
        }

        .session-suggestions {
            display: none;                 /* baÅŸlangÄ±Ã§ta gizli */
            gap: 6px;
            flex-wrap: wrap;
            margin-top: -8px;
            margin-bottom: 12px;
            font-size: 0.8rem;
            align-items: center;
        }

        .session-suggestions.visible {
            display: flex;                 /* visible olduÄŸunda flex */
        }

        .session-chip {
            border-radius: 999px;
            border: none;
            padding: 4px 10px;
            background: #e5e7eb;
            color: #111827;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .session-chip:hover {
            background: #dbeafe;
        }

    </style>
</head>
<body>
<div class="container">
    <h1>Parking Scanner</h1>

    <form id="scan-form">
        <label for="sessionName">Scan session name</label>
        <input
                type="text"
                id="sessionName"
                name="sessionName"
                placeholder="MORNING-2025-11-25-01"
        />

        <div id="session-suggestions" class="session-suggestions">
            <span style="align-self:center; color:#6b7280;">Quick set:</span>
            <button type="button" class="session-chip" data-period="MORNING">Morning</button>
            <button type="button" class="session-chip" data-period="NOON">Noon</button>
            <button type="button" class="session-chip" data-period="EVENING">Evening</button>
            <button type="button" class="session-chip" id="session-today-auto">Auto (now)</button>
        </div>


        <label for="licensePlate">License plate</label>
        <input
                type="text"
                id="licensePlate"
                name="licensePlate"
                placeholder="HHL32H"
                class="awesomplete"
                required
                oninput="this.value = this.value.toUpperCase()"
        />
        <div id="plate-status" style="font-size:0.8rem; margin-top:-10px; margin-bottom:10px; color:#4b5563;"></div>


        <label for="location">Location</label>
        <input
                type="text"
                id="location"
                name="location"
                placeholder="NORTH-01 or SOUTH-05"
                class="awesomplete"
                required
        >

        <button type="submit" id="submit-btn">Submit</button>
    </form>

    <div id="message" class="message"></div>

    <div class="nav">
        <a href="/residents.html">Manage residents &amp; plates â†’</a><br>
        <a href="/stats.html">View session stats â†’</a>
        <form method="post" action="/logout" style="margin-top:8px; text-align:center;">
            <button type="submit" style="background:none;border:none;color:#2563eb;cursor:pointer;font-size:0.9rem;">
                Logout
            </button>
        </form>

    </div>
</div>

<script>
    const form = document.getElementById('scan-form');
    const messageEl = document.getElementById('message');
    const submitBtn = document.getElementById('submit-btn');

    const plateStatusEl = document.getElementById('plate-status');
    const sessionInput = document.getElementById('sessionName');
    const sessionSuggestions = document.getElementById('session-suggestions');

    const licensePlateInput = document.getElementById('licensePlate');
    const locationInput = document.getElementById('location');

    let knownPlatesSet = new Set();
    let awesomplete = null;

    // Track which plates belong to residents vs outsiders
    let residentPlatesSet = new Set();
    let outsiderPlatesSet = new Set();

    let knownLocations = [];
    let locationAwesomplete = null;

    async function loadKnownLocations() {
        try {
            const res = await fetch('/locations/known');
            if (!res.ok) {
                console.warn('Failed to load known locations', res.status);
                return;
            }
            const data = await res.json();
            // Ã–rn: ["NORTH-01", "NORTH-02", ...]
            knownLocations = data;

            if (window.Awesomplete) {
                if (!locationAwesomplete) {
                    locationAwesomplete = new Awesomplete(locationInput, {
                        list: knownLocations,
                        minChars: 0,
                        maxItems: 20,
                        autoFirst: true
                    });
                } else {
                    locationAwesomplete.list = knownLocations;
                }
            }
        } catch (err) {
            console.warn('Error loading known locations', err);
        }
    }


    function getCurrentPeriod() {
        const hour = new Date().getHours();
        if (hour < 11) return 'MORNING';
        if (hour < 16) return 'NOON';
        return 'EVENING';
    }

    function buildSessionName(period) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${period}-${year}-${month}-${day}`;
    }


    async function loadKnownPlates() {
        try {
            const res = await fetch('/plates/known');
            if (!res.ok) {
                console.warn('Failed to load known plates', res.status);
                return;
            }
            const data = await res.json();

            // data can be either ["ABC123", ...] (backward compatible)
            // or an object { residents: [...], outsiders: [...] }
            let allPlatesUpper = [];
            residentPlatesSet = new Set();
            outsiderPlatesSet = new Set();

            if (Array.isArray(data)) {
                // Older/simple format: we don't know which are outsiders, so treat all as generic known plates
                allPlatesUpper = data.map(p => p.toUpperCase());
            } else if (data && (Array.isArray(data.residents) || Array.isArray(data.outsiders))) {
                const residentUpper = (data.residents || []).map(p => p.toUpperCase());
                const outsiderUpper = (data.outsiders || []).map(p => p.toUpperCase());

                residentUpper.forEach(p => residentPlatesSet.add(p));
                outsiderUpper.forEach(p => outsiderPlatesSet.add(p));

                allPlatesUpper = Array.from(new Set([...residentUpper, ...outsiderUpper]));
            } else {
                console.warn('Unexpected known plates payload', data);
                return;
            }

            knownPlatesSet = new Set(allPlatesUpper);

            if (window.Awesomplete) {
                if (!awesomplete) {
                    awesomplete = new Awesomplete(licensePlateInput, {
                        list: allPlatesUpper,
                        minChars: 1,
                        maxItems: 10,
                        autoFirst: true
                    });
                } else {
                    awesomplete.list = allPlatesUpper;
                }
            } else {
                console.warn('Awesomplete not available yet');
            }
        } catch (err) {
            console.warn('Error loading known plates', err);
        }
    }

    function updatePlateStatus(plate) {
        if (!plate) {
            plateStatusEl.textContent = '';
            plateStatusEl.style.color = '#4b5563';
            return;
        }

        const upper = plate.toUpperCase();
        if (residentPlatesSet.has(upper)) {
            plateStatusEl.textContent = 'âœ… Known resident license plate';
            plateStatusEl.style.color = '#15803d';
        } else if (outsiderPlatesSet.has(upper)) {
            plateStatusEl.textContent = 'ðŸš— Previously seen outsider plate';
            plateStatusEl.style.color = '#1d4ed8';
        } else {
            plateStatusEl.textContent = 'ðŸš— Not registered (will be treated as outsider)';
            plateStatusEl.style.color = '#b45309';
        }
    }

    // TÃ¼m sayfa + Awesomplete yÃ¼klendikten sonra plakalarÄ± Ã§ek
    window.addEventListener('load', loadKnownPlates);
    window.addEventListener('load', loadKnownLocations);



    // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda sessionName boÅŸsa, current period + tarih ile doldur
    window.addEventListener('load', () => {
        if (!sessionInput.value.trim()) {
            const period = getCurrentPeriod();
            sessionInput.value = buildSessionName(period);
        }

        // Quick set butonlarÄ±
        const chips = document.querySelectorAll('.session-chip[data-period]');
        chips.forEach(chip => {
            chip.addEventListener('click', () => {
                const period = chip.dataset.period;
                sessionInput.value = buildSessionName(period);
            });
        });

        // "Auto (now)" butonu â€“ ÅŸu anki saate gÃ¶re MORNING/NOON/EVENING
        const autoBtn = document.getElementById('session-today-auto');
        if (autoBtn) {
            autoBtn.addEventListener('click', () => {
                const period = getCurrentPeriod();
                sessionInput.value = buildSessionName(period);
            });
        }

        // input'a tÄ±klayÄ±nca quick set satÄ±rÄ±nÄ± gÃ¶ster
        sessionInput.addEventListener('focus', () => {
            sessionSuggestions.classList.add('visible');
        });

        // focus kaybolunca biraz gecikmeli gizle (butona tÄ±klamaya izin vermek iÃ§in)
        sessionInput.addEventListener('blur', () => {
            setTimeout(() => {
                sessionSuggestions.classList.remove('visible');
            }, 150);
        });


    });


    // Input yazÄ±ldÄ±kÃ§a status gÃ¼ncelle
    licensePlateInput.addEventListener('input', () => {
        const plate = licensePlateInput.value.trim();
        updatePlateStatus(plate);
    });

    // Awesomplete'ten seÃ§im yapÄ±lÄ±nca da status'u gÃ¼ncelle
    licensePlateInput.addEventListener('awesomplete-selectcomplete', (e) => {
        // e.text.value varsa onu kullan, yoksa input'tan al
        const selected = e.text && e.text.value ? e.text.value : licensePlateInput.value.trim();
        updatePlateStatus(selected);
    });

    // BazÄ± tarayÄ±cÄ±larda sadece change tetiklenebiliyor, onu da yakalayalÄ±m
    licensePlateInput.addEventListener('change', () => {
        const plate = licensePlateInput.value.trim();
        updatePlateStatus(plate);
    });

    locationInput.addEventListener('focus', () => {
        if (locationAwesomplete && knownLocations.length > 0) {
            // mevcut deÄŸeri tetiklemek iÃ§in
            Awesomplete.$.fire(locationInput, "input");
        }
    });

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        messageEl.textContent = '';
        messageEl.className = 'message';

        const sessionName = sessionInput.value.trim();
        const licensePlate = licensePlateInput.value.trim().toUpperCase();
        const location = locationInput.value.trim();

        updatePlateStatus(licensePlate);

        if (!licensePlate || !location) {
            messageEl.textContent = 'Please fill in license plate and location.';
            messageEl.classList.add('error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';

        try {
            const body = {
                licensePlate,
                location,
                sessionName: sessionName || null
            };

            const response = await fetch('/scan-entries', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (response.ok) {
                messageEl.textContent = 'Saved âœ…';
                messageEl.classList.add('success');
                licensePlateInput.value = '';
                locationInput.value = '';
                updatePlateStatus('');
            } else {
                messageEl.textContent = 'Error: ' + response.status;
                messageEl.classList.add('error');
            }
        } catch (err) {
            messageEl.textContent = 'Network error: ' + err.message;
            messageEl.classList.add('error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit';
        }
    });
</script>




</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parking Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 640px;
            margin: 40px auto;
            background: #ffffff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1.05rem;
            box-sizing: border-box;
            margin-bottom: 16px;
        }

        h1 {
            font-size: 1.6rem;
            margin-top: 0;
            margin-bottom: 16px;
            text-align: center;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }

        button {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: #2563eb;
            color: white;
        }

        button:disabled {
            opacity: 0.6;
            cursor: default;
        }

        .message {
            margin-top: 16px;
            text-align: center;
            font-size: 0.95rem;
        }

        .message.success {
            color: #15803d;
        }

        .message.error {
            color: #b91c1c;
        }

        .nav {
            text-align: center;
            margin-top: 12px;
            font-size: 0.9rem;
        }

        .nav a {
            color: #2563eb;
            text-decoration: none;
        }

        .nav a:hover {
            text-decoration: underline;
        }

        .session-suggestions {
            display: none;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: -8px;
            margin-bottom: 12px;
            font-size: 0.8rem;
            align-items: center;
        }

        .session-suggestions.visible {
            display: flex;
        }

        .session-chip {
            border-radius: 999px;
            border: none;
            padding: 4px 10px;
            background: #e5e7eb;
            color: #111827;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .session-chip:hover {
            background: #dbeafe;
        }

        /* Simple full-screen overlay for side selection */
        .side-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .side-overlay.hidden {
            display: none;
        }

        .side-dialog {
            background: #ffffff;
            padding: 20px 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 360px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .side-dialog h2 {
            margin-top: 0;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .side-dialog select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .side-dialog button {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: none;
            background: #2563eb;
            color: #ffffff;
            font-weight: 600;
            cursor: pointer;
        }

        .side-dialog small {
            display: block;
            margin-top: 6px;
            color: #6b7280;
            font-size: 0.8rem;
        }

        .slot-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .slot-label {
            font-weight: 600;
            color: #111827;
        }

        .slot-controls {
            display: flex;
            gap: 6px;
        }

        .slot-btn {
            padding: 4px 10px;
            border-radius: 999px;
            border: none;
            background: #e5e7eb;
            color: #111827;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .slot-btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        /* Camera scanner styles */
        .camera-container {
            margin-bottom: 12px;
        }

        .camera-btn {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: #059669;
            color: white;
            margin-bottom: 8px;
        }

        .camera-btn:hover {
            background: #047857;
        }

        #camera-preview {
            width: 100%;
            border-radius: 8px;
            background: #1f2937;
            display: none;
        }

        #capture-canvas {
            display: none;
        }

        .camera-controls {
            display: none;
            gap: 8px;
            margin-top: 8px;
        }

        .camera-controls.visible {
            display: flex;
        }

        .camera-controls button {
            flex: 1;
        }

        #capture-btn {
            background: #dc2626;
        }

        #capture-btn:hover {
            background: #b91c1c;
        }

        #stop-camera-btn {
            background: #6b7280;
        }

        #stop-camera-btn:hover {
            background: #4b5563;
        }

        #ocr-status {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 8px;
            text-align: center;
        }

        #ocr-status.success {
            color: #15803d;
        }

        #ocr-status.error {
            color: #dc2626;
        }
    </style>
</head>
<body>

<!-- Side selection overlay shown when page loads -->
<div id="side-overlay" class="side-overlay">
    <div class="side-dialog">
        <h2>Select parking side</h2>
        <select id="side-select">
            <option value="" disabled selected>Select side...</option>
            <option value="NORTH">North</option>
            <option value="SOUTH">South</option>
        </select>
        <button type="button" id="side-confirm-btn">Continue</button>
        <small>You can refresh the page to choose a different side.</small>
    </div>
</div>

<div class="container">
    <h1>Parking Scanner</h1>

    <form id="scan-form">
        <label for="sessionName">Scan session name</label>
        <input
                type="text"
                id="sessionName"
                name="sessionName"
                placeholder="MORNING-2025-11-25-01"
        />

        <div id="session-suggestions" class="session-suggestions">
            <span style="align-self:center; color:#6b7280;">Quick set:</span>
            <button type="button" class="session-chip" data-period="MORNING">Morning</button>
            <button type="button" class="session-chip" data-period="NOON">Noon</button>
            <button type="button" class="session-chip" data-period="EVENING">Evening</button>
            <button type="button" class="session-chip" id="session-today-auto">Auto (now)</button>
        </div>

        <!-- New button to reopen side selection popup -->
        <button type="button" id="change-side-btn" style="margin-bottom:12px;background:#e5e7eb;color:#111827;">
            Change parking side
        </button>

        <label for="licensePlate">License plate</label>
        <input
                type="text"
                id="licensePlate"
                name="licensePlate"
                placeholder="HHL32H"
                class="awesomplete"
                required
                oninput="this.value = this.value.toUpperCase()"
        />

        <!-- Camera scanner for license plate OCR -->
        <div class="camera-container">
            <button type="button" id="scan-plate-btn" class="camera-btn">
                üì∑ Scan plate with camera
            </button>
            <video id="camera-preview" autoplay playsinline></video>
            <canvas id="capture-canvas"></canvas>
            <div class="camera-controls" id="camera-controls">
                <button type="button" id="capture-btn">üì∏ Capture & Read</button>
                <button type="button" id="stop-camera-btn">‚úï Cancel</button>
            </div>
            <div id="ocr-status"></div>
        </div>

        <div id="plate-status" style="font-size:0.8rem; margin-top:-10px; margin-bottom:10px; color:#4b5563;"></div>

        <!-- Automatic location counter row -->
        <div id="slot-row" class="slot-row" style="display:none;">
            <div>
                <span style="color:#6b7280;">Current spot:</span>
                <span id="slot-label" class="slot-label">-</span>
            </div>
            <div class="slot-controls">
                <button type="button" id="slot-prev" class="slot-btn">Prev</button>
                <button type="button" id="slot-next" class="slot-btn">Next</button>
            </div>
        </div>

        <!-- No parking checkbox -->
        <label style="display:flex; align-items:center; gap:6px; font-size:0.9rem; margin-bottom:12px;">
            <input type="checkbox" id="no-parking-checkbox" style="width:auto;">
            <span>This spot is a <strong>NO PARKING</strong> area</span>
        </label>

        <!-- Location field removed; location will be the selected side + index (e.g. NORTH-01) -->

        <button type="submit" id="submit-btn">Submit</button>
    </form>

    <div id="message" class="message"></div>

    <div class="nav">
        <a href="/residents.html">Manage residents &amp; plates ‚Üí</a><br>
        <a href="/stats.html">View session stats ‚Üí</a>
        <form method="post" action="/logout" style="margin-top:8px; text-align:center;">
            <button type="submit" style="background:none;border:none;color:#2563eb;cursor:pointer;font-size:0.9rem;">
                Logout
            </button>
        </form>

    </div>
</div>

<script>
    const form = document.getElementById('scan-form');
    const messageEl = document.getElementById('message');
    const submitBtn = document.getElementById('submit-btn');

    const plateStatusEl = document.getElementById('plate-status');
    const sessionInput = document.getElementById('sessionName');
    const sessionSuggestions = document.getElementById('session-suggestions');

    const licensePlateInput = document.getElementById('licensePlate');
    const noParkingCheckbox = document.getElementById('no-parking-checkbox');

    // Camera scanner elements
    const scanPlateBtn = document.getElementById('scan-plate-btn');
    const cameraPreview = document.getElementById('camera-preview');
    const captureCanvas = document.getElementById('capture-canvas');
    const cameraControls = document.getElementById('camera-controls');
    const captureBtn = document.getElementById('capture-btn');
    const stopCameraBtn = document.getElementById('stop-camera-btn');
    const ocrStatusEl = document.getElementById('ocr-status');
    let cameraStream = null;

    // Slot / automatic counter elements
    const slotRow = document.getElementById('slot-row');
    const slotLabelEl = document.getElementById('slot-label');
    const slotPrevBtn = document.getElementById('slot-prev');
    const slotNextBtn = document.getElementById('slot-next');

    // Side selection elements
    const sideOverlay = document.getElementById('side-overlay');
    const sideSelect = document.getElementById('side-select');
    const sideConfirmBtn = document.getElementById('side-confirm-btn');
    const changeSideBtn = document.getElementById('change-side-btn');

    // Currently selected side ("NORTH" or "SOUTH")
    let selectedSide = null;

    // Automatic counter for spots on the chosen side
    let currentIndex = 1; // 1-based

    // --- Persistence helpers for current spot per side ---
    const STORAGE_KEY_NORTH = 'scanner_current_index_north';
    const STORAGE_KEY_SOUTH = 'scanner_current_index_south';

    // Known plates + Awesomplete for license plate
    let knownPlatesSet = new Set();
    let awesomplete = null;

    // Track which plates belong to residents vs outsiders
    let residentPlatesSet = new Set();
    let outsiderPlatesSet = new Set();

    async function loadKnownPlates() {
        try {
            const res = await fetch('/plates/known');
            if (!res.ok) {
                console.warn('Failed to load known plates', res.status);
                return;
            }
            const data = await res.json();

            // data can be either ["ABC123", ...] (backward compatible)
            // or an object { residents: [...], outsiders: [...] }
            let allPlatesUpper = [];
            residentPlatesSet = new Set();
            outsiderPlatesSet = new Set();

            if (Array.isArray(data)) {
                // Older/simple format: we don't know which are outsiders, so treat all as generic known plates
                allPlatesUpper = data.map(p => p.toUpperCase());
            } else if (data && (Array.isArray(data.residents) || Array.isArray(data.outsiders))) {
                const residentUpper = (data.residents || []).map(p => p.toUpperCase());
                const outsiderUpper = (data.outsiders || []).map(p => p.toUpperCase());

                residentUpper.forEach(p => residentPlatesSet.add(p));
                outsiderUpper.forEach(p => outsiderPlatesSet.add(p));

                allPlatesUpper = Array.from(new Set([...residentUpper, ...outsiderUpper]));
            } else {
                console.warn('Unexpected known plates payload', data);
                return;
            }

            knownPlatesSet = new Set(allPlatesUpper);

            if (window.Awesomplete) {
                if (!awesomplete) {
                    awesomplete = new Awesomplete(licensePlateInput, {
                        list: allPlatesUpper,
                        minChars: 1,
                        maxItems: 10,
                        autoFirst: true
                    });
                } else {
                    awesomplete.list = allPlatesUpper;
                }
            } else {
                console.warn('Awesomplete not available yet');
            }
        } catch (err) {
            console.warn('Error loading known plates', err);
        }
    }

    function loadStoredIndexForSide(side) {
        if (!window.localStorage) return null;
        const key = side === 'NORTH' ? STORAGE_KEY_NORTH : STORAGE_KEY_SOUTH;
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const parsed = parseInt(raw, 10);
        return Number.isFinite(parsed) && parsed > 0 ? parsed : null;
    }

    function storeIndexForSide(side, index) {
        if (!window.localStorage) return;
        const key = side === 'NORTH' ? STORAGE_KEY_NORTH : STORAGE_KEY_SOUTH;
        localStorage.setItem(key, String(index));
    }

    function getCurrentPeriod() {
        const hour = new Date().getHours();
        if (hour < 11) return 'MORNING';
        if (hour < 16) return 'NOON';
        return 'EVENING';
    }

    function buildSessionName(period) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${period}-${year}-${month}-${day}`;
    }

    function updatePlateStatus(plate) {
        if (!plate) {
            plateStatusEl.textContent = '';
            plateStatusEl.style.color = '#4b5563';
            return;
        }

        const upper = plate.toUpperCase();
        if (residentPlatesSet.has(upper)) {
            plateStatusEl.textContent = '‚úÖ Known resident license plate';
            plateStatusEl.style.color = '#15803d';
        } else if (outsiderPlatesSet.has(upper)) {
            plateStatusEl.textContent = 'üöó Previously seen outsider plate';
            plateStatusEl.style.color = '#1d4ed8';
        } else {
            plateStatusEl.textContent = 'üöó Not registered (will be treated as outsider)';
            plateStatusEl.style.color = '#b45309';
        }
    }

    // Slot label and navigation
    function formatSlotLabel(side, index) {
        const num = String(index).padStart(2, '0');
        return `${side}-${num}`;
    }

    function updateSlotUI() {
        if (!selectedSide) {
            slotRow.style.display = 'none';
            return;
        }
        slotRow.style.display = 'flex';
        slotLabelEl.textContent = formatSlotLabel(selectedSide, currentIndex);

        // Prev is disabled on the first spot
        slotPrevBtn.disabled = currentIndex <= 1;
        // Next is never disabled (you can keep going forward as needed)
        slotNextBtn.disabled = false;
    }

    function getCurrentLocation() {
        if (!selectedSide) return null;
        return formatSlotLabel(selectedSide, currentIndex);
    }

    function goPrevSlot() {
        if (currentIndex > 1) {
            currentIndex--;
            updateSlotUI();
        }
    }

    function goNextSlot() {
        currentIndex++;
        updateSlotUI();
        // Persist new index for this side
        if (selectedSide) {
            storeIndexForSide(selectedSide, currentIndex);
        }
    }

    slotPrevBtn.addEventListener('click', () => {
        goPrevSlot();
        if (selectedSide) {
            storeIndexForSide(selectedSide, currentIndex);
        }
    });
    slotNextBtn.addEventListener('click', goNextSlot);

    changeSideBtn.addEventListener('click', () => {
        // Show the overlay again so user can switch side; keep previously selected side in dropdown
        sideOverlay.classList.remove('hidden');
        if (selectedSide) {
            sideSelect.value = selectedSide;
        }
    });

    // Wire side selection overlay
    sideConfirmBtn.addEventListener('click', () => {
        const value = sideSelect.value;
        if (!value) {
            alert('Please select a side (North or South).');
            return;
        }
        selectedSide = value; // "NORTH" or "SOUTH"

        // Try to restore last used index for this side, then continue from last+1
        const stored = loadStoredIndexForSide(selectedSide);
        if (stored && stored > 0) {
            currentIndex = stored + 1;
        } else {
            currentIndex = 1;
        }

        updateSlotUI();
        sideOverlay.classList.add('hidden');
    });

    // Ensure user selects a side before scanning
    function ensureSideSelected() {
        if (!selectedSide) {
            alert('Please select parking side (North or South) first.');
            sideOverlay.classList.remove('hidden');
            return false;
        }
        return true;
    }

    // T√ºm sayfa + Awesomplete y√ºklendikten sonra plakalarƒ± √ßek
    window.addEventListener('load', loadKnownPlates);

    // Sayfa a√ßƒ±ldƒ±ƒüƒ±nda sessionName bo≈üsa, current period + tarih ile doldur
    window.addEventListener('load', () => {
        if (!sessionInput.value.trim()) {
            const period = getCurrentPeriod();
            sessionInput.value = buildSessionName(period);
        }

        const chips = document.querySelectorAll('.session-chip[data-period]');
        chips.forEach(chip => {
            chip.addEventListener('click', () => {
                const period = chip.dataset.period;
                sessionInput.value = buildSessionName(period);
            });
        });

        const autoBtn = document.getElementById('session-today-auto');
        if (autoBtn) {
            autoBtn.addEventListener('click', () => {
                const period = getCurrentPeriod();
                sessionInput.value = buildSessionName(period);
            });
        }

        sessionInput.addEventListener('focus', () => {
            sessionSuggestions.classList.add('visible');
        });

        sessionInput.addEventListener('blur', () => {
            setTimeout(() => {
                sessionSuggestions.classList.remove('visible');
            }, 150);
        });
    });

    // Input yazƒ±ldƒ±k√ßa status g√ºncelle
    licensePlateInput.addEventListener('input', () => {
        const plate = licensePlateInput.value.trim();
        updatePlateStatus(plate);
    });

    licensePlateInput.addEventListener('awesomplete-selectcomplete', (e) => {
        const selected = e.text && e.text.value ? e.text.value : licensePlateInput.value.trim();
        updatePlateStatus(selected);
    });

    licensePlateInput.addEventListener('change', () => {
        const plate = licensePlateInput.value.trim();
        updatePlateStatus(plate);
    });

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        messageEl.textContent = '';
        messageEl.className = 'message';

        if (!ensureSideSelected()) {
            return;
        }

        const sessionName = sessionInput.value.trim();
        const licensePlate = licensePlateInput.value.trim().toUpperCase();
        const noParking = !!noParkingCheckbox.checked;

        updatePlateStatus(licensePlate);

        if (!licensePlate) {
            messageEl.textContent = 'Please fill in license plate.';
            messageEl.classList.add('error');
            return;
        }

        const locationValue = getCurrentLocation();
        if (!locationValue && !noParking) {
            messageEl.textContent = 'Location is not ready. Please select side again.';
            messageEl.classList.add('error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';

        try {
            const body = {
                licensePlate,
                location: locationValue,
                sessionName: sessionName || null,
                noParking
            };

            const response = await fetch('/scan-entries', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (response.ok) {
                messageEl.textContent = 'Saved ‚úÖ';
                messageEl.classList.add('success');
                licensePlateInput.value = '';
                updatePlateStatus('');
                noParkingCheckbox.checked = false;

                // Persist the index that was just used for this scan
                if (selectedSide) {
                    storeIndexForSide(selectedSide, currentIndex);
                }

                // Automatically advance to next spot after a successful scan
                if (!noParking) {
                    goNextSlot();
                }
            } else {
                messageEl.textContent = 'Error: ' + response.status;
                messageEl.classList.add('error');
            }
        } catch (err) {
            messageEl.textContent = 'Network error: ' + err.message;
            messageEl.classList.add('error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit';
        }
    });

    // ============ Camera Scanner Functions ============

    // Start camera
    scanPlateBtn.addEventListener('click', async () => {
        try {
            ocrStatusEl.textContent = 'Starting camera...';
            ocrStatusEl.className = '';

            cameraStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            });

            cameraPreview.srcObject = cameraStream;
            cameraPreview.style.display = 'block';
            cameraControls.classList.add('visible');
            scanPlateBtn.style.display = 'none';
            ocrStatusEl.textContent = 'üì∑ Point camera at license plate, then tap "Capture & Read"';
        } catch (err) {
            ocrStatusEl.textContent = '‚ùå Camera access denied: ' + err.message;
            ocrStatusEl.className = 'error';
            console.error('Camera error:', err);
        }
    });

    // Stop camera
    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        cameraPreview.style.display = 'none';
        cameraPreview.srcObject = null;
        cameraControls.classList.remove('visible');
        scanPlateBtn.style.display = 'block';
    }

    stopCameraBtn.addEventListener('click', () => {
        stopCamera();
        ocrStatusEl.textContent = '';
        ocrStatusEl.className = '';
    });

    // Capture and OCR
    captureBtn.addEventListener('click', async () => {
        if (!cameraStream) return;

        // Draw current video frame to canvas
        const ctx = captureCanvas.getContext('2d');
        captureCanvas.width = cameraPreview.videoWidth;
        captureCanvas.height = cameraPreview.videoHeight;
        ctx.drawImage(cameraPreview, 0, 0);

        // Show processing state
        ocrStatusEl.textContent = 'üîç Reading plate... (this may take a few seconds)';
        ocrStatusEl.className = '';
        captureBtn.disabled = true;
        stopCameraBtn.disabled = true;

        try {
            const result = await Tesseract.recognize(captureCanvas, 'eng', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const pct = Math.round(m.progress * 100);
                        ocrStatusEl.textContent = `üîç Reading plate... ${pct}%`;
                    }
                }
            });

            const rawText = result.data.text;
            console.log('OCR raw result:', rawText);

            // Clean up: keep only alphanumeric, common plate format
            const cleaned = rawText
                .toUpperCase()
                .replace(/[^A-Z0-9]/g, '')
                .trim();

            console.log('Cleaned plate:', cleaned);

            if (cleaned.length >= 3 && cleaned.length <= 12) {
                licensePlateInput.value = cleaned;
                updatePlateStatus(cleaned);
                ocrStatusEl.textContent = '‚úÖ Detected: ' + cleaned;
                ocrStatusEl.className = 'success';
                stopCamera();
            } else if (cleaned.length > 0) {
                ocrStatusEl.textContent = '‚ö†Ô∏è Partial read: "' + cleaned + '" - Try again or edit manually';
                ocrStatusEl.className = 'error';
                licensePlateInput.value = cleaned;
                updatePlateStatus(cleaned);
            } else {
                ocrStatusEl.textContent = '‚ö†Ô∏è Could not read plate. Try again with better lighting/angle.';
                ocrStatusEl.className = 'error';
            }
        } catch (err) {
            console.error('OCR error:', err);
            ocrStatusEl.textContent = '‚ùå OCR error: ' + err.message;
            ocrStatusEl.className = 'error';
        } finally {
            captureBtn.disabled = false;
            stopCameraBtn.disabled = false;
        }
    });
</script>

</body>
</html>

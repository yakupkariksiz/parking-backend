<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parking Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* User header bar */
        .user-header {
            background: #1e293b;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .user-header .app-name {
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            color: white;
        }

        .user-header .app-name:hover {
            color: #94a3b8;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Dropdown Menu */
        .nav-dropdown {
            position: relative;
        }

        .nav-dropdown-btn {
            background: #334155;
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-dropdown-btn:hover {
            background: #475569;
        }

        .nav-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-width: 200px;
            z-index: 100;
            overflow: hidden;
        }

        .nav-dropdown-content.show {
            display: block;
        }

        .nav-dropdown-content a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: #1e293b;
            text-decoration: none;
            font-size: 0.9rem;
            transition: background 0.15s;
        }

        .nav-dropdown-content a:hover {
            background: #f1f5f9;
        }

        .nav-dropdown-content a.active {
            background: #eff6ff;
            color: #2563eb;
            font-weight: 500;
        }

        .nav-dropdown-content .divider {
            height: 1px;
            background: #e2e8f0;
            margin: 4px 0;
        }

        .nav-dropdown-content .menu-icon {
            width: 18px;
            text-align: center;
        }

        .nav-dropdown-content .admin-badge {
            font-size: 0.65rem;
            background: #fef3c7;
            color: #92400e;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #4ade80;
        }

        .user-info .user-details {
            text-align: right;
        }

        .user-info .user-name {
            font-weight: 500;
        }

        .user-info .user-role {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .container {
            max-width: 640px;
            margin: 20px auto;
            background: #ffffff;
            padding: 20px;
            padding-bottom: 80px; /* Extra space at bottom for keyboard */
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            min-height: calc(100vh - 120px);
            max-height: calc(100vh - 80px);
            overflow-y: auto;
            position: relative;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 16px;
                padding-bottom: 100px;
                border-radius: 8px;
            }
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1.05rem;
            box-sizing: border-box;
            margin-bottom: 12px;
        }

        h1 {
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 12px;
            text-align: center;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        button {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: #2563eb;
            color: white;
        }

        /* Submit button specific styling */
        button[type="submit"] {
            background: #15803d;
            color: white;
            padding: 14px 16px;
            font-size: 1.1rem;
            margin-top: 16px;
            box-shadow: 0 4px 12px rgba(21, 128, 61, 0.3);
            transition: all 0.2s;
        }

        button[type="submit"]:hover:not(:disabled) {
            background: #166534;
            box-shadow: 0 6px 16px rgba(21, 128, 61, 0.4);
            transform: translateY(-1px);
        }

        button[type="submit"]:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: default;
        }

        .message {
            margin-top: 12px;
            text-align: center;
            font-size: 0.95rem;
        }

        .message.success {
            color: #15803d;
        }

        .message.error {
            color: #b91c1c;
        }

        .nav {
            text-align: center;
            margin-top: 12px;
            font-size: 0.9rem;
        }

        .nav a {
            color: #2563eb;
            text-decoration: none;
        }

        .nav a:hover {
            text-decoration: underline;
        }

        .session-suggestions {
            display: none;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: -6px;
            margin-bottom: 10px;
            font-size: 0.8rem;
            align-items: center;
        }

        .session-suggestions.visible {
            display: flex;
        }

        .session-chip {
            border-radius: 999px;
            border: none;
            padding: 4px 10px;
            background: #e5e7eb;
            color: #111827;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .session-chip:hover {
            background: #dbeafe;
        }


        /* Simple full-screen overlay for side selection */
        .side-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .side-overlay.hidden {
            display: none;
        }

        .side-dialog {
            background: #ffffff;
            padding: 20px 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 360px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            position: relative;
        }

        .side-dialog .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            border: none;
            background: #f3f4f6;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #6b7280;
            transition: background 0.2s, color 0.2s;
        }

        .side-dialog .close-btn:hover {
            background: #e5e7eb;
            color: #111827;
        }

        .side-dialog h2 {
            margin-top: 0;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .side-dialog select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .side-dialog button {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: none;
            background: #2563eb;
            color: #ffffff;
            font-weight: 600;
            cursor: pointer;
        }

        .side-dialog small {
            display: block;
            margin-top: 6px;
            color: #6b7280;
            font-size: 0.8rem;
        }

        .slot-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-size: 0.9rem;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .slot-label {
            font-weight: 600;
            color: #111827;
            transition: color 0.2s;
        }

        .slot-controls {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .slot-btn {
            padding: 4px 10px;
            border-radius: 999px;
            border: none;
            background: #e5e7eb;
            color: #111827;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .slot-btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .spot-adjust-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            border-radius: 50%;
            border: 2px solid #2563eb;
            background: white;
            color: #2563eb;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            line-height: 1;
        }

        .spot-adjust-btn:hover {
            background: #2563eb;
            color: white;
            transform: scale(1.1);
        }

        .spot-adjust-btn:active {
            transform: scale(0.95);
        }

        .spot-adjust-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            border-color: #9ca3af;
            color: #9ca3af;
        }

        .spot-adjust-btn:disabled:hover {
            background: white;
            color: #9ca3af;
            transform: none;
        }

        /* Camera scanner styles */
        .camera-container {
            margin-bottom: 10px;
        }

        .camera-btn {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: #059669;
            color: white;
            margin-bottom: 8px;
        }

        .camera-btn:hover {
            background: #047857;
        }

        #camera-preview {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 8px;
            background: #1f2937;
            display: none;
        }

        .camera-wrapper {
            position: relative;
            display: none;
        }

        .camera-wrapper.visible {
            display: block;
        }

        .scan-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60px;
            border: 3px solid #059669;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .scan-guide-text {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 0.75rem;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        #capture-canvas {
            display: none;
        }

        .camera-controls {
            display: none;
            gap: 8px;
            margin-top: 8px;
        }

        .camera-controls.visible {
            display: flex;
        }

        .camera-controls button {
            flex: 1;
        }

        #capture-btn {
            background: #dc2626;
        }

        #capture-btn:hover {
            background: #b91c1c;
        }

        #stop-camera-btn {
            background: #6b7280;
        }

        #stop-camera-btn:hover {
            background: #4b5563;
        }

        #ocr-status {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 8px;
            text-align: center;
        }

        #ocr-status.success {
            color: #15803d;
        }

        #ocr-status.error {
            color: #dc2626;
        }
    </style>
</head>
<body>

<!-- User header bar -->
<div class="user-header">
    <a href="/dashboard.html" class="app-name">üöó Parking Scanner</a>
    <div class="header-right">
        <!-- Navigation Dropdown -->
        <div class="nav-dropdown">
            <button class="nav-dropdown-btn" id="nav-dropdown-btn">
                <span>‚ò∞</span> Menu
            </button>
            <div class="nav-dropdown-content" id="nav-dropdown-content">
                <a href="/dashboard.html"><span class="menu-icon">üè†</span> Dashboard</a>
                <a href="/index.html" class="active"><span class="menu-icon">üì∑</span> Scan Plates</a>
                <div class="divider"></div>
                <a href="/residents.html"><span class="menu-icon">üë•</span> Residents</a>
                <a href="/stats.html"><span class="menu-icon">üìä</span> Session Stats</a>
                <a href="/occupancy.html"><span class="menu-icon">üìà</span> Occupancy Chart</a>
                <div class="divider"></div>
                <a href="#" onclick="document.getElementById('logout-form').submit(); return false;"><span class="menu-icon">üö™</span> Logout</a>
            </div>
        </div>
        <form id="logout-form" method="post" action="/logout" style="display:none;"></form>

        <!-- User Info -->
        <div class="user-info" id="user-info">
            <div class="user-details">
                <div class="user-name" id="user-name">Loading...</div>
                <div class="user-role" id="user-role"></div>
            </div>
            <img id="user-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" alt="User avatar" />
        </div>
    </div>
</div>

<!-- Side selection overlay shown when page loads -->
<div id="side-overlay" class="side-overlay">
    <div class="side-dialog">
        <button type="button" id="side-close-btn" class="close-btn" title="Close">‚úï</button>
        <h2>Select parking side</h2>
        <select id="side-select">
            <option value="" disabled selected>Select side...</option>
            <option value="NORTH">North</option>
            <option value="SOUTH">South</option>
        </select>
        <button type="button" id="side-confirm-btn">Continue</button>
        <small>You can close this and select later using "Change parking side" button.</small>
    </div>
</div>

<div class="container">
    <h1>Parking Scanner</h1>

    <form id="scan-form">
        <label for="sessionName">Scan session name</label>
        <input
                type="text"
                id="sessionName"
                name="sessionName"
                placeholder="MORNING-2025-11-25-01"
        />

        <div id="session-suggestions" class="session-suggestions">
            <span style="align-self:center; color:#6b7280;">Quick set:</span>
            <button type="button" class="session-chip" data-period="MORNING">Morning</button>
            <button type="button" class="session-chip" data-period="NOON">Noon</button>
            <button type="button" class="session-chip" data-period="EVENING">Evening</button>
            <button type="button" class="session-chip" id="session-today-auto">Auto (now)</button>
        </div>

        <!-- New button to reopen side selection popup -->
        <button type="button" id="change-side-btn" style="margin-bottom:12px;background:#e5e7eb;color:#111827;">
            Change parking side
        </button>

        <label for="licensePlate">License plate</label>
        <input
                type="text"
                id="licensePlate"
                name="licensePlate"
                placeholder="HHL32H"
                class="awesomplete"
                required
                oninput="this.value = this.value.toUpperCase()"
        />

        <!-- Camera scanner for license plate OCR -->
        <div class="camera-container">
            <button type="button" id="scan-plate-btn" class="camera-btn">
                üì∑ Scan plate with camera
            </button>
            <div class="camera-wrapper" id="camera-wrapper">
                <video id="camera-preview" autoplay playsinline muted></video>
                <div class="scan-guide">
                    <span class="scan-guide-text">Position plate inside this box</span>
                </div>
            </div>
            <canvas id="capture-canvas"></canvas>
            <canvas id="crop-canvas" style="display:none;"></canvas>
            <div id="captured-preview" style="display:none; margin-top:8px;">
                <img id="captured-image" alt="Captured license plate" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="width:100%; border-radius:8px; border:2px solid #059669;" />
            </div>
            <div class="camera-controls" id="camera-controls">
                <button type="button" id="capture-btn">üì∏ Capture & Read</button>
                <button type="button" id="stop-camera-btn">‚úï Cancel</button>
            </div>
            <div id="ocr-status"></div>
        </div>

        <div id="plate-status" style="font-size:0.8rem; margin-top:-10px; margin-bottom:10px; color:#4b5563;"></div>

        <!-- Automatic location counter row -->
        <div id="slot-row" class="slot-row" style="display:none;">
            <div style="display:flex; align-items:center; gap:8px;">
                <span style="color:#6b7280;">Current spot:</span>
                <button type="button" id="spot-dec" class="spot-adjust-btn" title="Decrease spot number">-</button>
                <span id="slot-label" class="slot-label">-</span>
                <button type="button" id="spot-inc" class="spot-adjust-btn" title="Increase spot number">+</button>
            </div>
            <div class="slot-controls">
                <button type="button" id="slot-prev" class="slot-btn">‚Üê Prev</button>
                <button type="button" id="slot-next" class="slot-btn">Next ‚Üí</button>
                <button type="button" id="clear-history-btn" class="slot-btn" style="background:#ef4444;color:white;" title="Clear all saved entries">Clear History</button>
            </div>
        </div>

        <!-- No parking checkbox -->
        <label style="display:flex; align-items:center; gap:6px; font-size:0.9rem; margin-bottom:12px;">
            <input type="checkbox" id="no-parking-checkbox" style="width:auto;">
            <span>This spot is a <strong>NO PARKING</strong> area</span>
        </label>

        <!-- Location field removed; location will be the selected side + index (e.g. NORTH-01) -->

        <button type="submit" id="submit-btn">Submit</button>
    </form>

    <div id="message" class="message"></div>

    <div class="nav">
        <a href="/dashboard.html">‚Üê Back to Dashboard</a><br>
        <a href="/residents.html">Manage residents &amp; plates ‚Üí</a><br>
        <a href="/stats.html">View session stats ‚Üí</a>

    </div>
</div>

<script>
    // Dropdown menu toggle
    const navDropdownBtn = document.getElementById('nav-dropdown-btn');
    const navDropdownContent = document.getElementById('nav-dropdown-content');

    navDropdownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        navDropdownContent.classList.toggle('show');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
        navDropdownContent.classList.remove('show');
    });

    // User info elements
    const userNameEl = document.getElementById('user-name');
    const userRoleEl = document.getElementById('user-role');
    const userAvatarEl = document.getElementById('user-avatar');

    // Fetch and display current user
    async function loadCurrentUser() {
        try {
            const res = await fetch('/api/user/me');
            if (res.ok) {
                const user = await res.json();
                if (user.authenticated) {
                    userNameEl.textContent = user.name || user.email || 'User';
                    userRoleEl.textContent = user.role === 'ROLE_ADMIN' ? 'Admin' : 'User';
                    if (user.picture) {
                        userAvatarEl.src = user.picture;
                    }
                }
            }
        } catch (err) {
            console.warn('Failed to load user info', err);
        }
    }
    loadCurrentUser();

    const form = document.getElementById('scan-form');
    const messageEl = document.getElementById('message');
    const submitBtn = document.getElementById('submit-btn');

    const plateStatusEl = document.getElementById('plate-status');
    const sessionInput = document.getElementById('sessionName');
    const sessionSuggestions = document.getElementById('session-suggestions');

    const licensePlateInput = document.getElementById('licensePlate');
    const noParkingCheckbox = document.getElementById('no-parking-checkbox');

    // Camera scanner elements
    const scanPlateBtn = document.getElementById('scan-plate-btn');
    const cameraWrapper = document.getElementById('camera-wrapper');
    const cameraPreview = document.getElementById('camera-preview');
    const captureCanvas = document.getElementById('capture-canvas');
    const cropCanvas = document.getElementById('crop-canvas');
    const cameraControls = document.getElementById('camera-controls');
    const captureBtn = document.getElementById('capture-btn');
    const stopCameraBtn = document.getElementById('stop-camera-btn');
    const ocrStatusEl = document.getElementById('ocr-status');
    const capturedPreview = document.getElementById('captured-preview');
    const capturedImage = document.getElementById('captured-image');
    let cameraStream = null;

    // Slot / automatic counter elements
    const slotRow = document.getElementById('slot-row');
    const slotLabelEl = document.getElementById('slot-label');
    const slotPrevBtn = document.getElementById('slot-prev');
    const slotNextBtn = document.getElementById('slot-next');

    // Side selection elements
    const sideOverlay = document.getElementById('side-overlay');
    const sideSelect = document.getElementById('side-select');
    const sideConfirmBtn = document.getElementById('side-confirm-btn');
    const sideCloseBtn = document.getElementById('side-close-btn');
    const changeSideBtn = document.getElementById('change-side-btn');

    // Currently selected side ("NORTH" or "SOUTH")
    let selectedSide = null;

    // Automatic counter for spots on the chosen side
    let currentIndex = 1; // 1-based

    // --- Persistence helpers for current spot per side ---
    const STORAGE_KEY_NORTH = 'scanner_current_index_north';
    const STORAGE_KEY_SOUTH = 'scanner_current_index_south';
    const STORAGE_KEY_HISTORY = 'scanner_plate_history';

    // History tracking: Map of location -> license plate
    // Example: { "NORTH-01": "ABC123", "NORTH-02": "XYZ789", "SOUTH-15": "DEF456" }
    let plateHistory = {};

    // Load plate history from localStorage
    function loadPlateHistory() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY_HISTORY);
            if (stored) {
                plateHistory = JSON.parse(stored);
            }
        } catch (err) {
            console.warn('Failed to load plate history', err);
            plateHistory = {};
        }
    }

    // Save plate history to localStorage
    function savePlateHistory() {
        try {
            localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(plateHistory));
        } catch (err) {
            console.warn('Failed to save plate history', err);
        }
    }

    // Store a plate for a specific location
    function storePlateForLocation(location, plate) {
        plateHistory[location] = plate;
        savePlateHistory();
    }

    // Get the stored plate for a specific location
    function getPlateForLocation(location) {
        return plateHistory[location] || null;
    }

    // Known plates + Awesomplete for license plate
    let knownPlatesSet = new Set();
    let awesomplete = null;

    // Track which plates belong to residents vs outsiders
    let residentPlatesSet = new Set();
    let outsiderPlatesSet = new Set();

    // Load plate history on page load
    loadPlateHistory();

    async function loadKnownPlates() {
        try {
            const res = await fetch('/plates/known');
            if (!res.ok) {
                console.warn('Failed to load known plates', res.status);
                return;
            }
            const data = await res.json();

            // data can be either ["ABC123", ...] (backward compatible)
            // or an object { residents: [...], outsiders: [...] }
            let allPlatesUpper = [];
            residentPlatesSet = new Set();
            outsiderPlatesSet = new Set();

            if (Array.isArray(data)) {
                // Older/simple format: we don't know which are outsiders, so treat all as generic known plates
                allPlatesUpper = data.map(p => p.toUpperCase());
            } else if (data && (Array.isArray(data.residents) || Array.isArray(data.outsiders))) {
                const residentUpper = (data.residents || []).map(p => p.toUpperCase());
                const outsiderUpper = (data.outsiders || []).map(p => p.toUpperCase());

                residentUpper.forEach(p => residentPlatesSet.add(p));
                outsiderUpper.forEach(p => outsiderPlatesSet.add(p));

                allPlatesUpper = Array.from(new Set([...residentUpper, ...outsiderUpper]));
            } else {
                console.warn('Unexpected known plates payload', data);
                return;
            }

            knownPlatesSet = new Set(allPlatesUpper);

            if (window.Awesomplete) {
                if (!awesomplete) {
                    awesomplete = new Awesomplete(licensePlateInput, {
                        list: allPlatesUpper,
                        minChars: 1,
                        maxItems: 10,
                        autoFirst: true
                    });
                } else {
                    awesomplete.list = allPlatesUpper;
                }
            } else {
                console.warn('Awesomplete not available yet');
            }
        } catch (err) {
            console.warn('Error loading known plates', err);
        }
    }

    function loadStoredIndexForSide(side) {
        if (!window.localStorage) return null;
        const key = side === 'NORTH' ? STORAGE_KEY_NORTH : STORAGE_KEY_SOUTH;
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const parsed = parseInt(raw, 10);
        return Number.isFinite(parsed) && parsed > 0 ? parsed : null;
    }

    function storeIndexForSide(side, index) {
        if (!window.localStorage) return;
        const key = side === 'NORTH' ? STORAGE_KEY_NORTH : STORAGE_KEY_SOUTH;
        localStorage.setItem(key, String(index));
    }

    function getCurrentPeriod() {
        const hour = new Date().getHours();
        if (hour < 11) return 'MORNING';
        if (hour < 16) return 'NOON';
        return 'EVENING';
    }

    function buildSessionName(period) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${period}-${year}-${month}-${day}`;
    }

    function updatePlateStatus(plate) {
        if (!plate) {
            plateStatusEl.textContent = '';
            plateStatusEl.style.color = '#4b5563';
            return;
        }

        const upper = plate.toUpperCase();
        if (residentPlatesSet.has(upper)) {
            plateStatusEl.textContent = '‚úÖ Known resident license plate';
            plateStatusEl.style.color = '#15803d';
        } else if (outsiderPlatesSet.has(upper)) {
            plateStatusEl.textContent = 'üöó Previously seen outsider plate';
            plateStatusEl.style.color = '#1d4ed8';
        } else {
            plateStatusEl.textContent = 'üöó Not registered (will be treated as outsider)';
            plateStatusEl.style.color = '#b45309';
        }
    }

    // Slot label and navigation
    function formatSlotLabel(side, index) {
        const num = String(index).padStart(2, '0');
        return `${side}-${num}`;
    }

    function updateSlotUI() {
        if (!selectedSide) {
            slotRow.style.display = 'none';
            return;
        }
        slotRow.style.display = 'flex';

        const location = getCurrentLocation();
        const storedPlate = getPlateForLocation(location);

        // Add indicator if this slot has been scanned before
        const indicator = storedPlate ? ' ‚úì' : '';
        slotLabelEl.textContent = formatSlotLabel(selectedSide, currentIndex) + indicator;

        // Change color if already scanned
        if (storedPlate) {
            slotLabelEl.style.color = '#15803d';
        } else {
            slotLabelEl.style.color = '#111827';
        }

        // Prev is disabled on the first spot
        slotPrevBtn.disabled = currentIndex <= 1;
        // Next is never disabled (you can keep going forward as needed)
        slotNextBtn.disabled = false;

        // Update spot adjustment buttons if they exist (initialized later in the code)
        const spotDecBtn = document.getElementById('spot-dec');
        const spotIncBtn = document.getElementById('spot-inc');
        if (spotDecBtn && spotIncBtn) {
            spotDecBtn.disabled = currentIndex <= 1;
            spotIncBtn.disabled = false;
        }

        // Pre-fill license plate if there's history for this slot
        if (storedPlate) {
            licensePlateInput.value = storedPlate;
            updatePlateStatus(storedPlate);
            messageEl.textContent = 'üìù Previous entry loaded';
            messageEl.className = 'message';
            messageEl.style.color = '#2563eb';
            // Clear message after 2 seconds
            setTimeout(() => {
                if (messageEl.textContent === 'üìù Previous entry loaded') {
                    messageEl.textContent = '';
                }
            }, 2000);
        } else {
            // Clear the input if no history
            if (licensePlateInput.value) {
                licensePlateInput.value = '';
                updatePlateStatus('');
            }
        }
    }

    function getCurrentLocation() {
        if (!selectedSide) return null;
        return formatSlotLabel(selectedSide, currentIndex);
    }

    function goPrevSlot() {
        if (currentIndex > 1) {
            currentIndex--;
            updateSlotUI();
        }
    }

    function goNextSlot() {
        currentIndex++;
        updateSlotUI();
        // Persist new index for this side
        if (selectedSide) {
            storeIndexForSide(selectedSide, currentIndex);
        }
    }

    slotPrevBtn.addEventListener('click', () => {
        goPrevSlot();
        if (selectedSide) {
            storeIndexForSide(selectedSide, currentIndex);
        }
    });
    slotNextBtn.addEventListener('click', goNextSlot);

    // Spot adjustment buttons - only change the spot number, don't affect anything else
    const spotDecBtn = document.getElementById('spot-dec');
    const spotIncBtn = document.getElementById('spot-inc');

    function updateSpotOnly() {
        if (!selectedSide) return;

        // Update just the label, don't load history or clear input
        const location = getCurrentLocation();
        const storedPlate = getPlateForLocation(location);
        const indicator = storedPlate ? ' ‚úì' : '';
        slotLabelEl.textContent = formatSlotLabel(selectedSide, currentIndex) + indicator;

        if (storedPlate) {
            slotLabelEl.style.color = '#15803d';
        } else {
            slotLabelEl.style.color = '#111827';
        }

        // Update button states
        spotDecBtn.disabled = currentIndex <= 1;
        spotIncBtn.disabled = false;
    }

    spotDecBtn.addEventListener('click', () => {
        if (currentIndex > 1) {
            currentIndex--;
            updateSpotOnly();
        }
    });

    spotIncBtn.addEventListener('click', () => {
        currentIndex++;
        updateSpotOnly();
    });

    // Clear history button
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    clearHistoryBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear all saved license plate entries? This cannot be undone.')) {
            plateHistory = {};
            savePlateHistory();
            updateSlotUI();
            messageEl.textContent = 'üóëÔ∏è History cleared';
            messageEl.className = 'message';
            messageEl.style.color = '#dc2626';
            setTimeout(() => {
                if (messageEl.textContent === 'üóëÔ∏è History cleared') {
                    messageEl.textContent = '';
                }
            }, 2000);
        }
    });

    changeSideBtn.addEventListener('click', () => {
        // Show the overlay again so user can switch side; keep previously selected side in dropdown
        sideOverlay.classList.remove('hidden');
        if (selectedSide) {
            sideSelect.value = selectedSide;
        }
    });

    // Close button on side selection popup
    sideCloseBtn.addEventListener('click', () => {
        sideOverlay.classList.add('hidden');
    });

    // Wire side selection overlay
    sideConfirmBtn.addEventListener('click', () => {
        const value = sideSelect.value;
        if (!value) {
            alert('Please select a side (North or South).');
            return;
        }
        selectedSide = value; // "NORTH" or "SOUTH"

        // Try to restore last used index for this side, then continue from last+1
        const stored = loadStoredIndexForSide(selectedSide);
        if (stored && stored > 0) {
            currentIndex = stored + 1;
        } else {
            currentIndex = 1;
        }

        updateSlotUI();
        sideOverlay.classList.add('hidden');
    });

    // Ensure user selects a side before scanning
    function ensureSideSelected() {
        if (!selectedSide) {
            alert('Please select parking side (North or South) first.');
            sideOverlay.classList.remove('hidden');
            return false;
        }
        return true;
    }

    // T√ºm sayfa + Awesomplete y√ºklendikten sonra plakalarƒ± √ßek
    window.addEventListener('load', loadKnownPlates);

    // Sayfa a√ßƒ±ldƒ±ƒüƒ±nda sessionName bo≈üsa, current period + tarih ile doldur
    window.addEventListener('load', () => {
        if (!sessionInput.value.trim()) {
            const period = getCurrentPeriod();
            sessionInput.value = buildSessionName(period);
        }

        const chips = document.querySelectorAll('.session-chip[data-period]');
        chips.forEach(chip => {
            chip.addEventListener('click', () => {
                const period = chip.dataset.period;
                sessionInput.value = buildSessionName(period);
            });
        });

        const autoBtn = document.getElementById('session-today-auto');
        if (autoBtn) {
            autoBtn.addEventListener('click', () => {
                const period = getCurrentPeriod();
                sessionInput.value = buildSessionName(period);
            });
        }

        sessionInput.addEventListener('focus', () => {
            sessionSuggestions.classList.add('visible');
        });

        sessionInput.addEventListener('blur', () => {
            setTimeout(() => {
                sessionSuggestions.classList.remove('visible');
            }, 150);
        });
    });

    // Input yazƒ±ldƒ±k√ßa status g√ºncelle
    licensePlateInput.addEventListener('input', () => {
        const plate = licensePlateInput.value.trim();
        updatePlateStatus(plate);
    });

    // Ensure submit button is visible when license plate input is focused
    licensePlateInput.addEventListener('focus', () => {
        setTimeout(() => {
            submitBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 300);
    });

    licensePlateInput.addEventListener('awesomplete-selectcomplete', (e) => {
        const selected = e.text && e.text.value ? e.text.value : licensePlateInput.value.trim();
        updatePlateStatus(selected);
    });

    licensePlateInput.addEventListener('change', () => {
        const plate = licensePlateInput.value.trim();
        updatePlateStatus(plate);
    });

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        messageEl.textContent = '';
        messageEl.className = 'message';

        if (!ensureSideSelected()) {
            return;
        }

        const sessionName = sessionInput.value.trim();
        const licensePlate = licensePlateInput.value.trim().toUpperCase();
        const noParking = !!noParkingCheckbox.checked;

        updatePlateStatus(licensePlate);

        if (!licensePlate) {
            messageEl.textContent = 'Please fill in license plate.';
            messageEl.classList.add('error');
            return;
        }

        const locationValue = getCurrentLocation();
        if (!locationValue && !noParking) {
            messageEl.textContent = 'Location is not ready. Please select side again.';
            messageEl.classList.add('error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';

        try {
            const body = {
                licensePlate,
                location: locationValue,
                sessionName: sessionName || null,
                noParking
            };

            const response = await fetch('/scan-entries', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (response.ok) {
                // Store the license plate in history before clearing
                if (locationValue) {
                    storePlateForLocation(locationValue, licensePlate);
                }

                messageEl.textContent = 'Saved ‚úÖ';
                messageEl.classList.add('success');
                licensePlateInput.value = '';
                updatePlateStatus('');
                noParkingCheckbox.checked = false;

                // Persist the index that was just used for this scan
                if (selectedSide) {
                    storeIndexForSide(selectedSide, currentIndex);
                }

                // Automatically advance to next spot after a successful scan
                if (!noParking) {
                    goNextSlot();
                }
            } else {
                messageEl.textContent = 'Error: ' + response.status;
                messageEl.classList.add('error');
            }
        } catch (err) {
            messageEl.textContent = 'Network error: ' + err.message;
            messageEl.classList.add('error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit';
        }
    });

    // ============ Camera Scanner Functions ============

    // Check if camera is supported (requires HTTPS in production)
    function isCameraSupported() {
        return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
    }

    // Initialize camera button state
    if (!isCameraSupported()) {
        scanPlateBtn.textContent = 'üì∑ Camera requires HTTPS';
        scanPlateBtn.style.background = '#9ca3af';
        scanPlateBtn.style.cursor = 'not-allowed';
        scanPlateBtn.disabled = true;
        ocrStatusEl.textContent = '‚ö†Ô∏è Camera scanning requires HTTPS. Use manual entry.';
        ocrStatusEl.className = 'error';
    }

    // Start camera
    scanPlateBtn.addEventListener('click', async () => {
        if (!isCameraSupported()) {
            ocrStatusEl.textContent = '‚ùå Camera not available. Requires HTTPS connection.';
            ocrStatusEl.className = 'error';
            return;
        }

        try {
            ocrStatusEl.textContent = 'Starting camera...';
            ocrStatusEl.className = '';
            capturedPreview.style.display = 'none';

            cameraStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    advanced: [{ torch: false }]
                }
            });

            // Try to disable torch/flash if supported
            const track = cameraStream.getVideoTracks()[0];
            if (track && track.getCapabilities) {
                const capabilities = track.getCapabilities();
                if (capabilities.torch) {
                    await track.applyConstraints({ advanced: [{ torch: false }] });
                }
            }

            cameraPreview.srcObject = cameraStream;
            await cameraPreview.play();
            cameraPreview.style.display = 'block';
            cameraWrapper.classList.add('visible');
            cameraControls.classList.add('visible');
            scanPlateBtn.style.display = 'none';
            ocrStatusEl.textContent = 'üì∑ Position plate inside the green box, then tap "Capture & Read"';
        } catch (err) {
            ocrStatusEl.textContent = '‚ùå Camera error: ' + (err.message || 'Access denied');
            ocrStatusEl.className = 'error';
            console.error('Camera error:', err);
        }
    });

    // Stop camera
    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        cameraPreview.style.display = 'none';
        cameraPreview.srcObject = null;
        cameraWrapper.classList.remove('visible');
        cameraControls.classList.remove('visible');
        scanPlateBtn.style.display = 'block';
    }

    stopCameraBtn.addEventListener('click', () => {
        stopCamera();
        capturedPreview.style.display = 'none';
        ocrStatusEl.textContent = '';
        ocrStatusEl.className = '';
    });

    // Capture and OCR
    captureBtn.addEventListener('click', async () => {
        if (!cameraStream) return;

        // Draw current video frame to canvas
        const ctx = captureCanvas.getContext('2d');
        captureCanvas.width = cameraPreview.videoWidth;
        captureCanvas.height = cameraPreview.videoHeight;
        ctx.drawImage(cameraPreview, 0, 0);

        // Calculate crop region (matching the green guide box: 80% width, centered, 60px height ratio)
        const videoWidth = cameraPreview.videoWidth;
        const videoHeight = cameraPreview.videoHeight;
        const displayWidth = cameraPreview.offsetWidth;
        const displayHeight = cameraPreview.offsetHeight;

        // Scale factor between actual video and displayed size
        const scaleX = videoWidth / displayWidth;
        const scaleY = videoHeight / displayHeight;

        // Guide box dimensions (80% width, 60px height at display size)
        const guideDisplayWidth = displayWidth * 0.8;
        const guideDisplayHeight = 60;
        const guideDisplayX = (displayWidth - guideDisplayWidth) / 2;
        const guideDisplayY = (displayHeight - guideDisplayHeight) / 2;

        // Convert to video coordinates
        const cropX = guideDisplayX * scaleX;
        const cropY = guideDisplayY * scaleY;
        const cropWidth = guideDisplayWidth * scaleX;
        const cropHeight = guideDisplayHeight * scaleY;

        // Crop the image to just the guide box area
        const cropCtx = cropCanvas.getContext('2d');
        cropCanvas.width = cropWidth;
        cropCanvas.height = cropHeight;
        cropCtx.drawImage(captureCanvas, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

        // Apply simple grayscale + contrast boost for OCR
        const imageData = cropCtx.getImageData(0, 0, cropWidth, cropHeight);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
            // Convert to grayscale
            const gray = (data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114);
            // Boost contrast
            const contrast = 1.5;
            const factor = (259 * (contrast * 100 + 255)) / (255 * (259 - contrast * 100));
            const newGray = Math.min(255, Math.max(0, factor * (gray - 128) + 128));
            data[i] = newGray;     // R
            data[i + 1] = newGray; // G
            data[i + 2] = newGray; // B
        }
        cropCtx.putImageData(imageData, 0, 0);

        // Show cropped image preview
        const imageDataUrl = cropCanvas.toDataURL('image/png');
        capturedImage.src = imageDataUrl;
        capturedPreview.style.display = 'block';

        // Hide camera wrapper
        cameraWrapper.classList.remove('visible');

        // Show processing state
        ocrStatusEl.textContent = 'üîç Reading plate... (this may take a few seconds)';
        ocrStatusEl.className = '';
        captureBtn.disabled = true;
        captureBtn.textContent = '‚è≥ Processing...';
        stopCameraBtn.disabled = true;

        try {
            // Use simple Tesseract.recognize with basic settings
            const result = await Tesseract.recognize(cropCanvas, 'eng', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const pct = Math.round(m.progress * 100);
                        ocrStatusEl.textContent = `üîç Reading plate... ${pct}%`;
                    }
                }
            });

            const rawText = result.data.text;
            console.log('OCR raw result:', rawText);

            // Clean up: keep only alphanumeric and hyphens
            let cleaned = rawText
                .toUpperCase()
                .replace(/[^A-Z0-9-]/g, '')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '')
                .trim();


            // If result is too long, try to extract plate-like patterns
            // Dutch plates are typically 6 chars like XX-99-XX or XXX-99-X
            if (cleaned.length > 10) {
                // Try to find a plate pattern (2-3 letters/numbers separated by hyphens)
                const platePattern = /[A-Z0-9]{1,3}-?[A-Z0-9]{1,3}-?[A-Z0-9]{1,3}/g;
                const matches = cleaned.match(platePattern);
                if (matches && matches.length > 0) {
                    // Take the first reasonable match
                    cleaned = matches[0];
                } else {
                    // Just take first 8 characters
                    cleaned = cleaned.substring(0, 8);
                }
            }

            console.log('Cleaned plate:', cleaned);

            if (cleaned.length >= 4 && cleaned.length <= 10) {
                licensePlateInput.value = cleaned;
                updatePlateStatus(cleaned);
                ocrStatusEl.textContent = '‚úÖ Detected: ' + cleaned + ' (edit if needed)';
                ocrStatusEl.className = 'success';
                stopCamera();
                capturedPreview.style.display = 'none';
            } else if (cleaned.length > 0) {
                ocrStatusEl.textContent = '‚ö†Ô∏è Partial read: "' + cleaned + '" - Tap Capture again or edit manually';
                ocrStatusEl.className = 'error';
                licensePlateInput.value = cleaned;
                updatePlateStatus(cleaned);
                // Show camera again for retry
                cameraWrapper.classList.add('visible');
                capturedPreview.style.display = 'none';
            } else {
                ocrStatusEl.textContent = '‚ö†Ô∏è Could not read plate. Position plate inside the green box and try again.';
                ocrStatusEl.className = 'error';
                // Show camera again for retry
                cameraWrapper.classList.add('visible');
                capturedPreview.style.display = 'none';
            }
        } catch (err) {
            console.error('OCR error:', err);
            ocrStatusEl.textContent = '‚ùå OCR error: ' + (err.message || 'Unknown error');
            ocrStatusEl.className = 'error';
            // Show camera again for retry
            cameraWrapper.classList.add('visible');
            capturedPreview.style.display = 'none';
        } finally {
            captureBtn.disabled = false;
            captureBtn.textContent = 'üì∏ Capture & Read';
            stopCameraBtn.disabled = false;
        }
    });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parking Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 480px;
            margin: 40px auto;
            background: #ffffff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
        }

        h1 {
            font-size: 1.6rem;
            margin-top: 0;
            margin-bottom: 16px;
            text-align: center;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            box-sizing: border-box;
            margin-bottom: 16px;
        }

        button {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: #2563eb;
            color: white;
        }

        button:disabled {
            opacity: 0.6;
            cursor: default;
        }

        .message {
            margin-top: 16px;
            text-align: center;
            font-size: 0.95rem;
        }

        .message.success {
            color: #15803d;
        }

        .message.error {
            color: #b91c1c;
        }

        .nav {
            text-align: center;
            margin-top: 12px;
            font-size: 0.9rem;
        }

        .nav a {
            color: #2563eb;
            text-decoration: none;
        }

        .nav a:hover {
            text-decoration: underline;
        }

        .session-chip {
            border-radius: 999px;
            border: none;
            padding: 4px 10px;
            background: #e5e7eb;
            color: #111827;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .session-chip:hover {
            background: #dbeafe;
        }

    </style>
</head>
<body>
<div class="container">
    <h1>Parking Scanner</h1>

    <form id="scan-form">
        <label for="sessionName">Scan session name</label>
        <input
                type="text"
                id="sessionName"
                name="sessionName"
                placeholder="MORNING-2025-11-25-01"
        />

        <div id="session-suggestions" style="display:flex; gap:6px; flex-wrap:wrap; margin-top:-8px; margin-bottom:12px; font-size:0.8rem;">
            <span style="align-self:center; color:#6b7280;">Quick set:</span>
            <button type="button" class="session-chip" data-period="MORNING">Morning</button>
            <button type="button" class="session-chip" data-period="NOON">Noon</button>
            <button type="button" class="session-chip" data-period="EVENING">Evening</button>
            <button type="button" class="session-chip" id="session-today-auto">Auto (now)</button>
        </div>


        <label for="licensePlate">License plate</label>
        <input
                type="text"
                id="licensePlate"
                name="licensePlate"
                placeholder="HHL32H"
                class="awesomplete"
                required
                oninput="this.value = this.value.toUpperCase()"
        />
        <div id="plate-status" style="font-size:0.8rem; margin-top:-10px; margin-bottom:10px; color:#4b5563;"></div>


        <label for="location">Location</label>
        <input
                type="text"
                id="location"
                name="location"
                placeholder="North or South - Spot 01"
                required
        >

        <button type="submit" id="submit-btn">Submit</button>
    </form>

    <div id="message" class="message"></div>

    <div class="nav">
        <a href="/residents.html">Manage residents &amp; plates â†’</a><br>
        <a href="/stats.html">View session stats â†’</a>
    </div>
</div>

<script>
    const form = document.getElementById('scan-form');
    const messageEl = document.getElementById('message');
    const submitBtn = document.getElementById('submit-btn');

    const plateStatusEl = document.getElementById('plate-status');
    const sessionInput = document.getElementById('sessionName');
    const licensePlateInput = document.getElementById('licensePlate');
    const locationInput = document.getElementById('location');

    let knownPlatesSet = new Set();
    let awesomplete = null;

    function getCurrentPeriod() {
        const hour = new Date().getHours();
        if (hour < 11) return 'MORNING';
        if (hour < 16) return 'NOON';
        return 'EVENING';
    }

    function buildSessionName(period) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${period}-${year}-${month}-${day}`;
    }


    async function loadKnownPlates() {
        try {
            const res = await fetch('/plates/known');
            if (!res.ok) {
                console.warn('Failed to load known plates', res.status);
                return;
            }
            const data = await res.json();
            const upperList = data.map(p => p.toUpperCase());
            knownPlatesSet = new Set(upperList);

            // Awesomplete listesi
            if (window.Awesomplete) {
                if (!awesomplete) {
                    awesomplete = new Awesomplete(licensePlateInput, {
                        list: upperList,
                        minChars: 1,
                        maxItems: 10,
                        autoFirst: true
                    });
                } else {
                    awesomplete.list = upperList;
                }
            } else {
                console.warn('Awesomplete not available yet');
            }
        } catch (err) {
            console.warn('Error loading known plates', err);
        }
    }

    function updatePlateStatus(plate) {
        if (!plate) {
            plateStatusEl.textContent = '';
            plateStatusEl.style.color = '#4b5563';
            return;
        }

        const upper = plate.toUpperCase();
        if (knownPlatesSet.has(upper)) {
            plateStatusEl.textContent = 'âœ… Known resident license plate';
            plateStatusEl.style.color = '#15803d';
        } else {
            plateStatusEl.textContent = 'ðŸš— Not registered (will be treated as outsider)';
            plateStatusEl.style.color = '#b45309';
        }
    }

    // TÃ¼m sayfa + Awesomplete yÃ¼klendikten sonra plakalarÄ± Ã§ek
    window.addEventListener('load', loadKnownPlates);

    // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda sessionName boÅŸsa, current period + tarih ile doldur
    window.addEventListener('load', () => {
        if (!sessionInput.value.trim()) {
            const period = getCurrentPeriod();
            sessionInput.value = buildSessionName(period);
        }

        // Quick set butonlarÄ±
        const chips = document.querySelectorAll('.session-chip[data-period]');
        chips.forEach(chip => {
            chip.addEventListener('click', () => {
                const period = chip.dataset.period;
                sessionInput.value = buildSessionName(period);
            });
        });

        // "Auto (now)" butonu â€“ ÅŸu anki saate gÃ¶re MORNING/NOON/EVENING
        const autoBtn = document.getElementById('session-today-auto');
        if (autoBtn) {
            autoBtn.addEventListener('click', () => {
                const period = getCurrentPeriod();
                sessionInput.value = buildSessionName(period);
            });
        }
    });


    // Input yazÄ±ldÄ±kÃ§a status gÃ¼ncelle
    licensePlateInput.addEventListener('input', () => {
        const plate = licensePlateInput.value.trim();
        updatePlateStatus(plate);
    });

    // Awesomplete'ten seÃ§im yapÄ±lÄ±nca da status'u gÃ¼ncelle
    licensePlateInput.addEventListener('awesomplete-selectcomplete', (e) => {
        // e.text.value varsa onu kullan, yoksa input'tan al
        const selected = e.text && e.text.value ? e.text.value : licensePlateInput.value.trim();
        updatePlateStatus(selected);
    });

    // BazÄ± tarayÄ±cÄ±larda sadece change tetiklenebiliyor, onu da yakalayalÄ±m
    licensePlateInput.addEventListener('change', () => {
        const plate = licensePlateInput.value.trim();
        updatePlateStatus(plate);
    });


    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        messageEl.textContent = '';
        messageEl.className = 'message';

        const sessionName = sessionInput.value.trim();
        const licensePlate = licensePlateInput.value.trim().toUpperCase();
        const location = locationInput.value.trim();

        updatePlateStatus(licensePlate);

        if (!licensePlate || !location) {
            messageEl.textContent = 'Please fill in license plate and location.';
            messageEl.classList.add('error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';

        try {
            const body = {
                licensePlate,
                location,
                sessionName: sessionName || null
            };

            const response = await fetch('/scan-entries', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (response.ok) {
                messageEl.textContent = 'Saved âœ…';
                messageEl.classList.add('success');
                licensePlateInput.value = '';
                locationInput.value = '';
                updatePlateStatus('');
            } else {
                messageEl.textContent = 'Error: ' + response.status;
                messageEl.classList.add('error');
            }
        } catch (err) {
            messageEl.textContent = 'Network error: ' + err.message;
            messageEl.classList.add('error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit';
        }
    });
</script>




</body>
</html>
